<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Saudi Projects Tracker — Reliable Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50 text-gray-800">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between gap-3 flex-wrap">
      <h1 class="text-2xl font-semibold">Saudi Projects Tracker — Dashboard</h1>
      <button id="refreshBtn" class="px-3 py-2 rounded bg-black text-white">Refresh</button>
    </header>

    <!-- Filters (simple & reliable) -->
    <section class="grid md:grid-cols-2 gap-3">
      <select id="clientFilter" class="bg-white border rounded px-3 py-2">
        <option value="">Client — All</option>
      </select>
      <select id="statusFilter" class="bg-white border rounded px-3 py-2">
        <option value="">Status — All</option>
        <option>RFQ</option>
        <option>Quoted</option>
        <option>Won-PO</option>
        <option>Invoiced</option>
        <option>Paid</option>
      </select>
    </section>

    <!-- KPIs -->
    <section class="grid md:grid-cols-6 gap-4">
      <div class="bg-white rounded-2xl shadow p-4"><div class="text-sm text-gray-500">Total PO Value</div><div id="kpiPO" class="text-xl font-semibold">–</div></div>
      <div class="bg-white rounded-2xl shadow p-4"><div class="text-sm text-gray-500">Total Invoiced</div><div id="kpiInv" class="text-xl font-semibold">–</div></div>
      <div class="bg-white rounded-2xl shadow p-4"><div class="text-sm text-gray-500">Total Received</div><div id="kpiRecv" class="text-xl font-semibold">–</div></div>
      <div class="bg-white rounded-2xl shadow p-4"><div class="text-sm text-gray-500">Outstanding</div><div id="kpiOut" class="text-xl font-semibold">–</div></div>
      <div class="bg-white rounded-2xl shadow p-4"><div class="text-sm text-gray-500">POs Needing Follow-up</div><div id="kpiPOFollow" class="text-xl font-semibold">–</div></div>
      <div class="bg-white rounded-2xl shadow p-4"><div class="text-sm text-gray-500">Invoices Needing Follow-up</div><div id="kpiInvFollow" class="text-xl font-semibold">–</div></div>
    </section>

    <!-- Aging (informational) -->
    <section class="bg-white rounded-2xl shadow p-4">
      <div class="flex items-center justify-between">
        <div class="text-sm text-gray-600">Receivables Aging (SAR)</div>
        <div id="lastUpdated" class="text-xs text-gray-500"></div>
      </div>
      <canvas id="agingChart" height="110"></canvas>
    </section>

    <!-- Follow-ups -->
    <section class="grid lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow p-4 overflow-auto">
        <div class="text-sm font-medium mb-2">POs needing follow-up (Quoted, no PO)</div>
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100"><tr id="poFollowHead"></tr></thead>
          <tbody id="poFollowBody"></tbody>
        </table>
      </div>
      <div class="bg-white rounded-2xl shadow p-4 overflow-auto">
        <div class="text-sm font-medium mb-2">Invoices needing follow-up (Unpaid)</div>
        <table class="min-w-full text-sm">
          <thead class="bg-gray-100"><tr id="invFollowHead"></tr></thead>
          <tbody id="invFollowBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Main table -->
    <section class="bg-white rounded-2xl shadow overflow-auto">
      <table class="min-w-full text-sm">
        <thead class="bg-gray-100"><tr id="ordersHeader"></tr></thead>
        <tbody id="ordersBody"></tbody>
      </table>
    </section>

    <p class="text-xs text-gray-500">Source: Published Google Sheet (XLSX export). No date filters — simple, deterministic rules.</p>
  </div>

<script>
(async function(){
  // ------- CONFIG -------
  const SHEET_XLSX_URL =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRSMr042TGv2lQs-i6IwTwFLdfnmOvOKtSiiVa4wPfzQzhXo411PQBHajm8eqEqjlDZnqa_rvMizjoM/pub?output=xlsx';
  const CREDIT_DAYS = 30; // only used to compute a "due date" display
  const SAR = new Intl.NumberFormat('en-SA', { style: 'currency', currency: 'SAR', maximumFractionDigits: 0 });

  // ------- Utils -------
  const toStr = v => v == null ? '' : String(v).trim();
  const toNum = v => { const n = Number(String(v).replace(/[^0-9.\-]/g,'')); return Number.isFinite(n) ? n : 0; };
  const toDate = v => {
    if (!v && v!==0) return null;
    if (v instanceof Date) return v;
    const s = String(v).trim();
    if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s);
    if (/^\d{1,2}\/\d{1,2}\/\d{2,4}$/.test(s)) { const [d,m,y]=s.split('/').map(x=>parseInt(x,10)); return new Date(y<100?2000+y:y, m-1, d); }
    const d = new Date(s); return isNaN(d) ? null : d;
  };
  const fmt = d => d ? d.toISOString().slice(0,10) : '';

  // ------- Fetch + parse -------
  async function fetchWB(){
    const res = await fetch(SHEET_XLSX_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('Fetch failed '+res.status);
    const buf = await res.arrayBuffer();
    return XLSX.read(buf, { type: 'array' });
  }
  function sheetToJSON(wb){ const ws = wb.Sheets[wb.SheetNames[0]]; return XLSX.utils.sheet_to_json(ws, { defval: '' }); }

  // Mapping tuned to your columns
  function normalize(s){ return toStr(s).toLowerCase().replace(/[^a-z0-9]+/g,' ').trim(); }
  function buildMap(headers){
    const map = new Map(); headers.forEach(h=>map.set(normalize(h), h));
    const get = (...keys)=>{ for (const [k,orig] of map.entries()){ if (keys.some(key => key.split(' ').every(t=>k.includes(t)))) return orig; } return null; };
    return {
      client:          get('client'),
      work:            get('nature of work','description','scope'),
      hamcoOrOther:    get('hamco','other part'),
      price:           get('price'),
      rfq_date:        get('date'), // left Date
      offer_price:     get('offer price'),
      offer_sent_date: get('offer sent date'),
      comments:        get('comments','remarks','notes'),
      po_number:       get('po number','purchase order'),
      po_value:        get('po value','order value','contract value'),
      po_date:         get('po date'),
      invoice_no:      get('invoice'),
      invoice_date:    get('date'), // second Date, disambiguate below
      invoice_amount:  get('amount'),
      payment_note:    get('payment')
    };
  }
  function disambiguateDateHeaders(headers, m){
    // If both Date columns resolved to the same header, pick two distinct Date columns in order
    const allDates = headers.map((h,i)=>({h,i})).filter(x=>normalize(x.h)==='date');
    if (allDates.length>=2){
      m.rfq_date    = headers[allDates[0].i]; // left date
      m.invoice_date= headers[allDates[1].i]; // right-of-invoice date
    }
  }

  // Transform rows → deterministic model
  function transform(rows){
    if (!rows.length) return {items:[], clients:[]};
    const headers = Object.keys(rows[0]);
    const m = buildMap(headers);
    disambiguateDateHeaders(headers, m);

    const items = rows.map((r, i)=>{
      const client    = toStr(r[m.client]);
      const work      = toStr(r[m.work]);
      const hamco     = toStr(r[m.hamcoOrOther]);
      const price     = toNum(r[m.price]);

      const rfqDate   = toDate(r[m.rfq_date]);
      const offerPrice= toNum(r[m.offer_price]);
      const offerSent = toDate(r[m.offer_sent_date]);

      const comments  = toStr(r[m.comments]);

      const poNo      = toStr(r[m.po_number]);
      const poDate    = toDate(r[m.po_date]);
      const poValue   = toNum(r[m.po_value]);

      const invNo     = toStr(r[m.invoice_no]);
      const invDate   = toDate(r[m.invoice_date]);
      const invAmt    = toNum(r[m.invoice_amount]);

      const payNote   = toStr(r[m.payment_note]);
      const paidFlag  = /payment\s*received/i.test(payNote);
      const recvAmt   = paidFlag ? invAmt : 0;
      const outstanding = Math.max(0, invAmt - recvAmt);

      // Deterministic status ladder
      let status = 'RFQ';
      if (offerSent) status = 'Quoted';
      if (poNo)      status = 'Won-PO';
      if (invNo || invAmt) status = 'Invoiced';
      if (paidFlag)  status = 'Paid';

      // Follow-ups (no period thresholds)
      const needPOFollow  = (status === 'Quoted') && !poNo;
      const needInvFollow = (status === 'Invoiced') && outstanding > 0;

      // FYI: compute a due date for display only
      const dueDate = invDate ? new Date(invDate.getTime() + CREDIT_DAYS*86400000) : null;
      const today   = new Date();
      const overdue = needInvFollow && dueDate && today > dueDate;

      return {
        id: `REC-2025-${String(i+1).padStart(4,'0')}`,
        client, work, hamco, price,
        rfqDate, offerPrice, offerSent,
        comments,
        poNo, poDate, poValue,
        invNo, invDate, invAmt,
        paidFlag, recvAmt, outstanding,
        status, needPOFollow, needInvFollow, dueDate, overdue
      };
    });

    const clients = Array.from(new Set(items.map(x=>x.client).filter(Boolean))).sort();
    return { items, clients };
  }

  // ------- Render helpers -------
  const el = s=>document.querySelector(s);

  function fillClientFilter(clients){
    el('#clientFilter').innerHTML = '<option value="">Client — All</option>' +
      clients.map(c=>`<option>${c}</option>`).join('');
  }

  function kpi(items){
    const totalPO = items.reduce((a,x)=>a+(x.poValue||0),0);
    const totalInv = items.reduce((a,x)=>a+(x.invAmt||0),0);
    const totalRecv= items.reduce((a,x)=>a+(x.recvAmt||0),0);
    const totalOut = items.reduce((a,x)=>a+(x.outstanding||0),0);
    const poFollow = items.filter(x=>x.needPOFollow).length;
    const invFollow= items.filter(x=>x.needInvFollow).length;

    el('#kpiPO').textContent = SAR.format(totalPO);
    el('#kpiInv').textContent= SAR.format(totalInv);
    el('#kpiRecv').textContent= SAR.format(totalRecv);
    el('#kpiOut').textContent = SAR.format(totalOut);
    el('#kpiPOFollow').textContent = poFollow;
    el('#kpiInvFollow').textContent= invFollow;
  }

  function agingChart(items){
    const bk = {'0-30':0,'31-60':0,'61-90':0,'>90':0};
    const today = new Date();
    items.forEach(x=>{
      if (x.status!=='Invoiced') return;
      if (!x.invDate || x.outstanding<=0) return;
      const age = Math.floor((today - x.invDate)/86400000);
      if (age<=30) bk['0-30'] += x.outstanding;
      else if (age<=60) bk['31-60'] += x.outstanding;
      else if (age<=90) bk['61-90'] += x.outstanding;
      else bk['>90'] += x.outstanding;
    });
    const ctx = el('#agingChart').getContext('2d');
    if (window.__agingChart) window.__agingChart.destroy();
    window.__agingChart = new Chart(ctx, { type:'bar',
      data:{ labels:Object.keys(bk), datasets:[{label:'Outstanding (SAR)', data:Object.values(bk)}]},
      options:{ plugins:{ legend:{ display:false } } }
    });
  }

  function renderTable(headSel, bodySel, headers, rows){
    const head = el(headSel); head.innerHTML='';
    headers.forEach(h=>{ const th=document.createElement('th'); th.className="px-3 py-2 text-left font-medium text-gray-600 whitespace-nowrap"; th.textContent=h; head.appendChild(th);});
    const body = el(bodySel); body.innerHTML='';
    rows.forEach(r=>{
      const tr = document.createElement('tr'); tr.className="odd:bg-white even:bg-gray-50";
      r.forEach((v,i)=>{ const td=document.createElement('td'); td.className="px-3 py-2"+(i===1?"":" whitespace-nowrap"); td.textContent=v ?? ''; tr.appendChild(td);});
      body.appendChild(tr);
    });
  }

  function renderAll(model, filters){
    const items = model.items.filter(x =>
      (!filters.client || x.client===filters.client) &&
      (!filters.status || x.status===filters.status)
    );

    kpi(items);
    agingChart(items);

    // Follow-ups
    const poRows = items.filter(x=>x.needPOFollow)
      .map(x=>[x.client, x.work, fmt(x.offerSent), x.comments]);
    renderTable('#poFollowHead','#poFollowBody',
      ['Client','Work','Offer Sent','Comments'], poRows);

    const invRows = items.filter(x=>x.needInvFollow)
      .map(x=>{
        const over = x.overdue && x.dueDate ? Math.max(0, Math.floor((new Date()-x.dueDate)/86400000)) : '';
        return [x.client, x.invNo, fmt(x.invDate), fmt(x.dueDate), over, SAR.format(x.outstanding||0)];
      });
    renderTable('#invFollowHead','#invFollowBody',
      ['Client','Invoice No','Invoice Date','Due Date','Days Overdue','Outstanding'], invRows);

    // Main table
    const mainRows = items.map(x=>[
      x.id, x.client, x.work,
      fmt(x.offerSent),
      x.poNo, fmt(x.poDate), SAR.format(x.poValue||0),
      x.invNo, fmt(x.invDate), SAR.format(x.invAmt||0),
      x.paidFlag ? 'Yes' : '',
      SAR.format(x.outstanding||0),
      x.status,
      x.comments
    ]);
    renderTable('#ordersHeader','#ordersBody',
      ['ID','Client','Nature of Work','Offer Sent','PO No','PO Date','PO Value','Invoice No','Invoice Date','Invoice Amt','Payment Received?','Outstanding','Status','Comments'],
      mainRows);
  }

  // ------- Boot -------
  async function boot(){
    const wb = await fetchWB();
    const rows = sheetToJSON(wb);
    const model = transform(rows);

    fillClientFilter(model.clients);
    document.querySelector('#lastUpdated').textContent = `Loaded ${new Date().toLocaleString()}`;

    // initial render
    renderAll(model, { client:'', status:'' });

    // bindings
    document.querySelector('#clientFilter').addEventListener('change', e=>{
      renderAll(model, { client: e.target.value, status: document.querySelector('#statusFilter').value });
    });
    document.querySelector('#statusFilter').addEventListener('change', e=>{
      renderAll(model, { client: document.querySelector('#clientFilter').value, status: e.target.value });
    });
    document.querySelector('#refreshBtn').addEventListener('click', boot);
  }

  try { await boot(); }
  catch(e){ alert('Failed to load sheet: ' + e.message); }
})();
</script>
</body>
</html>
